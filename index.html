
<!DOCTYPE html>
<html>
<head>
    <title>MUJ Navigator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet & plugins CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <style>
        :root{
            --accent1: linear-gradient(135deg,#ff9966,#ff5e62);
            --accent-route: #00bcd4;
            --muted-road: #bfc4c6;
            --glass: rgba(255,255,255,0.12);
            --glass-strong: rgba(255,255,255,0.22);
            --ui-radius: 12px;
            --shadow: 0 10px 30px rgba(12,18,26,0.18);
        }
        html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
        #map{height:100vh;width:100%;background:#eaecef}

        /* Top input box */
        .input-box{
            position: absolute;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1200;
            width: calc(100% - 30px);
            max-width: 820px;
            padding: 10px;
            display:flex;
            gap:10px;
            align-items:center;
            border-radius:var(--ui-radius);
            background: var(--accent1);
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px) saturate(120%);
            border:1px solid rgba(255,255,255,0.06);
        }
        .input-left{ display:flex; gap:10px; align-items:center; flex:1 1 auto; }
        .input-left input{
            min-width:130px;
            padding:10px 12px;
            border-radius:10px;
            border:none;
            background: rgba(255,255,255,0.14);
            color:white;
            outline:none;
            font-size:15px;
        }
        .input-left input::placeholder{ color: rgba(255,255,255,0.95); font-style:italic; }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: rgba(0,0,0,0.18);
            color: #fff;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        .icon-btn {
            width:42px;height:42px;padding:0;justify-content:center;
            background: rgba(255,255,255,0.08);
        }
        .btn:hover{ transform: translateY(-2px); filter:brightness(1.03); }

        /* Suggestion dropdown (custom lightweight) */
        .suggestions {
            position:absolute;
            top: 58px; /* relative to .input-box, adjust */
            left: 50%;
            transform: translateX(-50%);
            z-index:1300;
            width: calc(100% - 30px);
            max-width:820px;
            pointer-events:none;
        }
        .suggest-list {
            pointer-events:auto;
            display:flex;
            gap:8px;
            padding:8px;
            background: rgba(0,0,0,0.55);
            border-radius:10px;
            box-shadow: var(--shadow);
            color:#fff;
        }
        .suggest-item {
            padding:8px 10px;
            border-radius:8px;
            background: rgba(255,255,255,0.06);
            cursor:pointer;
            font-weight:600;
            font-size:14px;
        }
        .suggest-item:hover { background: rgba(255,255,255,0.12); }

        /* Info box bottom-left */
        .travel-info-box {
            position: absolute;
            bottom: 14px;
            left: 14px;
            z-index: 1200;
            background: rgba(12,17,22,0.75);
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            font-size:14px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.25);
            backdrop-filter: blur(6px);
            min-width:160px;
        }
        .travel-info-box b{display:block;margin-bottom:6px;font-size:13px}

        /* Live location toggle */
        .live-toggle {
            position:absolute;
            bottom:14px;
            right:14px;
            z-index:1200;
            background: rgba(255,255,255,0.08);
            color:#fff;
            padding:8px 10px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.04);
            cursor:pointer;
            box-shadow: var(--shadow);
        }

        /* small responsive adjustments */
        @media (max-width:720px){
            .input-box{ width: calc(100% - 18px); padding:8px; gap:8px; top:10px; }
            .suggestions { top: 56px; }
            .input-left input { min-width: 90px; font-size:14px; padding:9px; }
        }
    </style>
</head>
<body>
    <div id="map" aria-hidden="false"></div>

    <div class="input-box" role="search" aria-label="Campus navigation">
        <div class="input-left">
            <input id="from" list="landmarks" type="text" placeholder="From (or use üìç)" aria-label="From location">
            <button class="btn icon-btn" onclick="useCurrentAsFrom()" title="Use current location">üìç</button>
            <input id="to" list="landmarks" type="text" placeholder="To" aria-label="To location">
        </div>

        <datalist id="landmarks">
            <option value="AB1 Block">
            <option value="AB2 Block">
            <option value="AB3 Block">
            <option value="BlueDove Mess">
            <option value="BluSpring Mess">
            <option value="Laundry">
            <option value="Central Library">
            <option value="Lecture Hall Complex">
            <option value="Main Gate">
            <option value="Gate 2">
            <option value="Grand Stairs">
        </datalist>

        <button class="btn" onclick="navigate()" title="Navigate">Go ‚ûú</button>
    </div>

    <!-- Lightweight suggestion area (shows available campus suggestions) -->
    <div class="suggestions" id="suggestions" aria-hidden="true">
        <div class="suggest-list" id="suggestList" style="display:none;"></div>
    </div>

    <div class="travel-info-box" id="travelInfo">
        <b>Trip</b>
        Distance: -- km<br>
        Time: -- mins
    </div>

    <button class="live-toggle" id="liveToggle" onclick="toggleLive()" title="Toggle live location">Start live location</button>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- Config ---
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5tb2xzcml2MDczIiwiYSI6ImNtZTYybGdqeDExNHgybG9sb25mZm8xdDkifQ.9-KhGDc-7Ip4KYTIUOe8tw';
        const WALKING_SPEED_KMPH = 5.0; // walking speed for time estimate

        // --- Map init ---
        const map = L.map('map').setView([26.8436, 75.5650], 16);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + MAPBOX_TOKEN, {
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            attribution: '¬© Mapbox ¬© OpenStreetMap'
        }).addTo(map);

        // --- Load campus roads from export.geojson (muted styling) ---
        fetch('export.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: feature => {
                        // muted colours based on highway tag if present
                        const c = (feature && feature.properties && feature.properties.highway) ? feature.properties.highway : '';
                        if (c === 'footway' || c === 'path') return { color: '#d6d8da', weight: 2, opacity: 0.9 };
                        if (c === 'residential' || c === 'service') return { color: '#c5c9cc', weight: 2, opacity: 0.9 };
                        return { color: '#bfc4c6', weight: 2, opacity: 0.9 };
                    }
                }).addTo(map);
            })
            .catch(err => {
                console.warn('Could not load export.geojson ‚Äî ensure file exists next to this HTML and that you run a local server.', err);
            });

        // --- Landmarks (preset campus suggestions) ---
        const LANDMARKS = {
            "AB1 Block": [26.842586, 75.564249],
            "AB2 Block": [26.843117, 75.566100],
            "AB3 Block": [26.844070, 75.564072],
            "BlueDove Mess": [26.840432, 75.561798],
            "BluSpring Mess": [26.841255, 75.561567],
            "Laundry": [26.840202, 75.561454],
            "Central Library": [26.841648, 75.565944],
            "Lecture Hall Complex": [26.844338, 75.564705],
            "Main Gate": [26.840729, 75.566325],
            "Gate 2": [26.841524, 75.563868],
            "Grand Stairs": [26.842811, 75.565360]
        };

        // Add soft markers for landmarks
        for (const [name, coord] of Object.entries(LANDMARKS)) {
            L.marker(coord).addTo(map).bindPopup(`<strong>${name}</strong>`);
        }

        // --- Live location (watch) ---
        let liveWatchId = null;
        let liveMarker = null;
        let liveAccuracyCircle = null;

        function startLiveLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation not supported by your browser.');
                return;
            }
            liveWatchId = navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const acc = pos.coords.accuracy || 20;

                if (!liveMarker) {
                    liveMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#1e90ff',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map).bindPopup('You (live)');
                } else {
                    liveMarker.setLatLng([lat, lon]);
                }

                if (!liveAccuracyCircle) {
                    liveAccuracyCircle = L.circle([lat, lon], { radius: acc, color: '#1e90ff', fillOpacity: 0.06 }).addTo(map);
                } else {
                    liveAccuracyCircle.setLatLng([lat, lon]);
                    liveAccuracyCircle.setRadius(acc);
                }
            }, err => {
                console.error('Live position error', err);
                alert('Unable to get live position.');
            }, { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 });
        }

        function stopLiveLocation() {
            if (liveWatchId !== null) {
                navigator.geolocation.clearWatch(liveWatchId);
                liveWatchId = null;
            }
            if (liveMarker) {
                map.removeLayer(liveMarker); liveMarker = null;
            }
            if (liveAccuracyCircle) {
                map.removeLayer(liveAccuracyCircle); liveAccuracyCircle = null;
            }
        }

        function toggleLive(){
            const btn = document.getElementById('liveToggle');
            if (liveWatchId === null) {
                startLiveLocation();
                btn.textContent = 'Stop live location';
            } else {
                stopLiveLocation();
                btn.textContent = 'Start live location';
            }
        }

        // Utility to set current coordinates into "from" input (reverse geocode optional)
        function useCurrentAsFrom(){
            if (!navigator.geolocation) {
                alert('Geolocation not supported.');
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                // simple label with coords ‚Äî we still use getCoords to accept landmarks or raw coords
                document.getElementById('from').value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                // show a temporary marker centered
                if (liveMarker) liveMarker.openPopup();
                else {
                    L.marker([lat, lon]).addTo(map).bindPopup('Current location').openPopup();
                }
                map.setView([lat, lon], 17);
            }, () => alert('Unable to get current location.'));
        }

        // getCoords: if input matches landmark key, return its coords; if input looks like "lat, lon" parse it; otherwise fail
        function getCoords(location, callback) {
            location = location.trim();
            // exact match with landmarks
            if (LANDMARKS[location]) {
                callback(LANDMARKS[location]);
                return;
            }
            // detect "lat, lon" pattern
            const latlonMatch = location.match(/^\s*([+-]?\d+\.\d+)\s*,\s*([+-]?\d+\.\d+)\s*$/);
            if (latlonMatch) {
                const lat = parseFloat(latlonMatch[1]);
                const lon = parseFloat(latlonMatch[2]);
                callback([lat, lon]);
                return;
            }
            // Not a campus suggestion or coords -> alert user (we intentionally limit to campus suggestions per your request)
            alert('Please use one of the campus suggestions or paste coordinates as "lat, lon".');
        }

        // show suggestion chips (only campus suggestions)
        const suggestWrapper = document.getElementById('suggestions');
        const suggestList = document.getElementById('suggestList');

        function showSuggestions(){
            // show suggestions as clickable chips
            suggestList.innerHTML = '';
            for (const name of Object.keys(LANDMARKS)) {
                const el = document.createElement('div');
                el.className = 'suggest-item';
                el.textContent = name;
                el.onclick = () => {
                    // if "to" has focus, fill it, else fill "from"
                    const active = document.activeElement;
                    if (active && active.id === 'to') document.getElementById('to').value = name;
                    else document.getElementById('from').value = name;
                    suggestWrapper.style.display = 'none';
                    suggestWrapper.setAttribute('aria-hidden','true');
                };
                suggestList.appendChild(el);
            }
            suggestWrapper.style.display = 'block';
            suggestWrapper.setAttribute('aria-hidden','false');
            suggestList.style.display = 'flex';
        }

        // hide suggestions
        function hideSuggestions(){
            suggestWrapper.style.display = 'none';
            suggestWrapper.setAttribute('aria-hidden','true');
            suggestList.style.display = 'none';
        }

        // show suggestions when focusing either input
        document.getElementById('from').addEventListener('focus', showSuggestions);
        document.getElementById('to').addEventListener('focus', showSuggestions);
        document.getElementById('from').addEventListener('input', ()=>{/* keep suggestions visible */});
        document.getElementById('to').addEventListener('input', ()=>{/* keep suggestions visible */});
        document.addEventListener('click', (e)=>{ // hide when clicking outside
            const box = document.querySelector('.input-box');
            if (!box.contains(e.target)) hideSuggestions();
        });

        // Routing control handle
        let routeControl = null;

        // navigate: compute route and update distance/time (walking speed)
        function navigate(){
            const fromVal = document.getElementById('from').value.trim();
            const toVal = document.getElementById('to').value.trim();

            if (!fromVal || !toVal) {
                alert('Please fill both From and To (use suggestions).');
                return;
            }

            // Resolve both coordinates (limited to campus suggestions or lat,lng)
            getCoords(fromVal, (fromCoords) => {
                getCoords(toVal, (toCoords) => {
                    // remove previous route
                    if (routeControl) {
                        map.removeControl(routeControl);
                        routeControl = null;
                    }

                    // add new routing control using OSRM
                    routeControl = L.Routing.control({
                        waypoints: [
                            L.latLng(fromCoords[0], fromCoords[1]),
                            L.latLng(toCoords[0], toCoords[1])
                        ],
                        createMarker: function(i, wp) {
                            // small numbered pin (A/B)
                            return L.marker(wp.latLng, {
                                icon: L.divIcon({
                                    html: `<div style="background:${getComputedStyle(document.documentElement).getPropertyValue('--accent-route') || '#00bcd4'}; color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-weight:700;">${i===0?'A':'B'}</div>`,
                                    className: '',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                })
                            });
                        },
                        routeWhileDragging: false,
                        addWaypoints: false,
                        show: false,
                        lineOptions: {
                            styles: [
                                { color: 'rgba(0,188,212,0.96)', weight: 5, opacity: 0.96 },
                                { color: 'rgba(255,255,255,0.06)', weight: 10, opacity: 0.06 }
                            ]
                        },
                        router: L.Routing.osrmv1({
                            serviceUrl: 'https://router.project-osrm.org/route/v1'
                        })
                    }).addTo(map);

                    routeControl.on('routesfound', function(e){
                        const r = e.routes[0];
                        // distance in meters
                        const distM = r.summary.totalDistance;
                        const distKm = (distM / 1000);
                        // walking time estimate (minutes) based on walking speed
                        const walkHours = distKm / WALKING_SPEED_KMPH;
                        const walkMins = Math.max(1, Math.round(walkHours * 60));

                        document.getElementById('travelInfo').innerHTML = `<b>Trip</b>Distance: ${distKm.toFixed(2)} km<br>Time (walk): ${walkMins} mins`;
                    });

                    routeControl.on('routeselected', function(e){
                        map.fitBounds(e.route.bounds.pad(0.12));
                    });
                });
            });
        }

        // Expose functions under the original names (you asked to keep them)
        // setCurrentLocation -> implemented as useCurrentAsFrom wrapper for compatibility
        function setCurrentLocation() { useCurrentAsFrom(); }
        function getCoordsWrapper(loc, cb) { getCoords(loc, cb); }
        function navigateWrapper(){ navigate(); }

        // optionally start live location automatically? No ‚Äî let user toggle
    </script>
</body>
</html>
