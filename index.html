<!DOCTYPE html>
<html>
<head>
    <title>MUJ Navigator</title>
    <link rel="icon" type="image/png" href="image/manipallogo.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        body { margin: 0; }
        #map { height: 100vh; }
        .input-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        input {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="input-box">
        <input type="text" id="from" placeholder="From">
        <input type="text" id="to" placeholder="To">
        <button onclick="route()">Navigate</button>
    </div>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([26.8436, 75.5650], 16); // MUJ default view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        const landmarks = {
            "AB1": [26.8432, 75.5654],
            "AB2": [26.8441, 75.5648],
            "Central Library": [26.8437, 75.5660],
            "Mess": [26.8445, 75.5658],
            "Laundry": [26.8429, 75.5656]
        };

        Object.entries(landmarks).forEach(([name, coords]) => {
            L.marker(coords).addTo(map).bindPopup(name);
        });

        let routeControl;

        function route() {
            const from = document.getElementById("from").value;
            const to = document.getElementById("to").value;

            if (routeControl) {
                map.removeControl(routeControl);
            }

            routeControl = L.Routing.control({
                waypoints: [],
                routeWhileDragging: true,
                geocoder: L.Control.Geocoder.nominatim(),
                router: L.Routing.mapbox('pk.eyJ1IjoiYW5tb2xzcml2MDczIiwiYSI6ImNtZTYybGdqeDExNHgybG9sb25mZm8xdDkifQ.9-KhGDc-7Ip4KYTIUOe8tw', {
                    profile: 'mapbox/walking'
                })
            }).addTo(map);

            // Set waypoints from text inputs
            Promise.all([
                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${from}.json?access_token=pk.eyJ1IjoiYW5tb2xzcml2MDczIiwiYSI6ImNtZTYybGdqeDExNHgybG9sb25mZm8xdDkifQ.9-KhGDc-7Ip4KYTIUOe8tw`)
                    .then(res => res.json()),
                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${to}.json?access_token=pk.eyJ1IjoiYW5tb2xzcml2MDczIiwiYSI6ImNtZTYybGdqeDExNHgybG9sb25mZm8xdDkifQ.9-KhGDc-7Ip4KYTIUOe8tw`)
                    .then(res => res.json())
            ]).then(([fromData, toData]) => {
                if (fromData.features.length && toData.features.length) {
                    routeControl.setWaypoints([
                        L.latLng(fromData.features[0].center[1], fromData.features[0].center[0]),
                        L.latLng(toData.features[0].center[1], toData.features[0].center[0])
                    ]);
                }
            });
        }

        // Auto-detect user location
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Add marker at user's location
            L.marker([lat, lon], { icon: L.icon({
                iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })})
            .addTo(map)
            .bindPopup("ðŸ“ You are here")
            .openPopup();

            // Center map on user's location
            map.setView([lat, lon], 17);

            // Reverse geocode and set "From" box
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?limit=1&access_token=pk.eyJ1IjoiYW5tb2xzcml2MDczIiwiYSI6ImNtZTYybGdqeDExNHgybG9sb25mZm8xdDkifQ.9-KhGDc-7Ip4KYTIUOe8tw`)
                .then(res => res.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        document.getElementById("from").value = data.features[0].place_name;
                    } else {
                        document.getElementById("from").value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    }
                })
                .catch(() => {
                    document.getElementById("from").value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                });
        }, () => {
            alert("Unable to retrieve your location");
        });
    </script>
</body>
</html>
