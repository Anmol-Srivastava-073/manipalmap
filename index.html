<!DOCTYPE html>
<html>
<head>
    <title>MUJ Navigator</title>
    <link rel="icon" type="image/png" href="image/manipallogo.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .search-box {
            position: absolute;
            top: 10px; left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex; gap: 5px;
            z-index: 999;
        }
        input, button {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button { background: #0078d7; color: white; cursor: pointer; }
        #info-box {
            position: absolute;
            bottom: 10px; left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 999;
        }
        #suggestions {
            position: absolute;
            top: 50px; left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            width: 200px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 999;
        }
        #suggestions div {
            padding: 8px;
            cursor: pointer;
        }
        #suggestions div:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="search-box">
        <input id="from" type="text" placeholder="From (leave empty for my location)">
        <input id="to" type="text" placeholder="To">
        <button onclick="startNavigation()">Go</button>
        <button onclick="getMyLocation()">üìç</button>
    </div>
    <div id="suggestions"></div>
    <div id="map"></div>
    <div id="info-box">Distance: - | Time: -</div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([26.8436, 75.5650], 17);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Load campus roads
        fetch('export.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, { style: { color: '#888', weight: 1 } }).addTo(map);
            });

        // Campus locations
        const campusLocations = {
            "AB1": [26.8431, 75.5655],
            "AB2": [26.8422, 75.5658],
            "Central Library": [26.8438, 75.5665],
            "Mess": [26.8443, 75.5648],
            "Laundry": [26.8440, 75.5639]
        };

        var userMarker, routeLine;

        function getMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
                map.setView([lat, lng], 18);
                document.getElementById('from').value = `${lat},${lng}`;
            }, err => alert("Location access denied."));
        }

        function startNavigation() {
            let fromVal = document.getElementById('from').value;
            let toVal = document.getElementById('to').value;

            let fromCoords = parseCoordsOrName(fromVal);
            let toCoords = parseCoordsOrName(toVal);

            if (!fromCoords || !toCoords) {
                alert("Please select valid points.");
                return;
            }

            if (routeLine) map.removeLayer(routeLine);

            routeLine = L.polyline([fromCoords, toCoords], { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(routeLine.getBounds());

            let dist = map.distance(fromCoords, toCoords);
            let walkingSpeed = 1.4; // m/s
            let timeSec = dist / walkingSpeed;

            document.getElementById('info-box').innerHTML =
                `Distance: ${(dist/1000).toFixed(2)} km | Time: ${(timeSec/60).toFixed(1)} min`;
        }

        function parseCoordsOrName(val) {
            if (!val) return null;
            if (val.includes(",")) {
                let [lat, lng] = val.split(",").map(Number);
                return [lat, lng];
            }
            if (campusLocations[val]) return campusLocations[val];
            return null;
        }

        // Suggestions
        document.getElementById('to').addEventListener('input', function() {
            showSuggestions(this.value);
        });

        function showSuggestions(query) {
            let sugBox = document.getElementById('suggestions');
            sugBox.innerHTML = "";
            if (!query) return;
            for (let name in campusLocations) {
                if (name.toLowerCase().includes(query.toLowerCase())) {
                    let div = document.createElement('div');
                    div.innerHTML = name;
                    div.onclick = () => {
                        document.getElementById('to').value = name;
                        sugBox.innerHTML = "";
                    };
                    sugBox.appendChild(div);
                }
            }
        }
    </script>
</body>
</html>
