<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <link rel="manifest" href="/manifest.json">
Â  Â  <meta name="theme-color" content="#007bff">
Â  Â  <title>Manipal Uninav</title>
Â  Â  <link rel="icon" type="image/png" href="image/weblogo.png" />
Â  Â  <meta charset="utf-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
Â  Â  <style>
Â  Â  Â  Â  html, body {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  }
Â  Â  Â  Â  #map {
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background: #dfe6e9;
Â  Â  Â  Â  Â  Â  transition: background-color 0.5s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* New CSS rule for dark mode background */
Â  Â  Â  Â  .dark-mode #map {
Â  Â  Â  Â  Â  Â  background: #2f3640;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-box {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  z-index: 1500;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #feb47b 0%, #ff7e5f 100%);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  padding: 10px 14px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  width: 90vw;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-box input {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-box input::placeholder {
Â  Â  Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 6px 14px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: #ff7e5f;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn:hover {
Â  Â  Â  Â  Â  Â  background-color: #fff4f1;
Â  Â  Â  Â  }
Â  Â  Â  Â  #suggestions {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 60px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  width: 90vw;
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  max-height: 180px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  z-index: 1600;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #suggestions div {
Â  Â  Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  #suggestions div:hover {
Â  Â  Â  Â  Â  Â  background: #f7d7ca;
Â  Â  Â  Â  Â  Â  color: #ff7e5f;
Â  Â  Â  Â  }
Â  Â  Â  Â  .travel-info-box {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 70px;
Â  Â  Â  Â  Â  Â  left: 18px;
Â  Â  Â  Â  Â  Â  z-index: 1500;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  Â  padding: 14px 18px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  min-width: 180px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  transition: background-color 0.5s ease, color 0.5s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* New CSS rule for dark mode info box */
Â  Â  Â  Â  .dark-mode .travel-info-box {
Â  Â  Â  Â  Â  Â  background: rgba(47, 54, 64, 0.95);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .live-toggle {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 18px;
Â  Â  Â  Â  Â  Â  right: 18px;
Â  Â  Â  Â  Â  Â  z-index: 1500;
Â  Â  Â  Â  Â  Â  background: #ff7e5f;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  padding: 8px 16px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(255, 126, 95, 0.6);
Â  Â  Â  Â  Â  Â  transition: background-color 0.25s ease;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .live-toggle:hover {
Â  Â  Â  Â  Â  Â  background: #feb47b;
Â  Â  Â  Â  }
Â  Â  Â  Â  .cancel-trip {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 18px;
Â  Â  Â  Â  Â  Â  left: 18px;
Â  Â  Â  Â  Â  Â  z-index: 1500;
Â  Â  Â  Â  Â  Â  background: #d63031;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  padding: 8px 16px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(214, 48, 49, 0.6);
Â  Â  Â  Â  Â  Â  transition: background-color 0.25s ease;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .cancel-trip:hover {
Â  Â  Â  Â  Â  Â  background: #ff7675;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Mobile adjustments */
Â  Â  Â  Â  @media (max-width: 600px) {
    .mobile-button-container {
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1500;
    }
    .live-toggle,
    .cancel-trip {
        position: static;
        width: 100%;
        margin: 0;
        border-radius: 12px;
        padding: 12px 0;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .travel-info-box {
        position: fixed; /* Changed to fixed to better handle different screen sizes */
        bottom: 120px; /* Adjusted to sit above the mobile button container */
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 400px;
        min-width: auto;
        font-size: 13px;
        padding: 12px 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .input-box {
        flex-direction: column;
        gap: 10px;
        padding: 12px 14px;
        font-size: 13px;
    }
    .input-box input {
        font-size: 13px;
        padding: 8px 10px;
    }
    .btn {
        width: 100%;
        text-align: center;
        padding: 10px 0;
        font-size: 13px;
    }
    #suggestions {
        max-height: 140px;
        font-size: 14px;
    }
}
Â  Â  Â  Â  #downloadOfflinebtn, #darkModeBtn {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  background: #4caf50;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  }
Â  Â  Â  Â  #downloadOfflinebtn {
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  background: #4caf50;
Â  Â  Â  Â  }
Â  Â  Â  Â  #darkModeBtn {
Â  Â  Â  Â  Â  Â  right: 150px;
Â  Â  Â  Â  Â  Â  background: #ff7e5f;
Â  Â  Â  Â  Â  Â  box-shadow: 0 3px 6px rgba(255, 126, 95, 0.6);
Â  Â  Â  Â  }
Â  Â  Â  Â  #offline-popup {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  Â  Â  width: 300px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #offline-popup .title {
Â  Â  Â  Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  #offline-popup .progress-bar {
Â  Â  Â  Â  Â  Â  background: #eee;
Â  Â  Â  Â  Â  Â  height: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  #offline-popup #offline-progress {
Â  Â  Â  Â  Â  Â  background: #4caf50;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  width: 0%;
Â  Â  Â  Â  }
Â  Â  Â  Â  #offline-popup #offline-status {
Â  Â  Â  Â  Â  Â  margin-top: 6px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="map" aria-hidden="false"></div>
Â  Â  <div class="input-box" role="search" aria-label="Campus navigation">
Â  Â  Â  Â  <input id="from" type="text" placeholder="From (or use ğŸ“)" aria-label="From location" autocomplete="off" aria-autocomplete="list" aria-controls="suggestions" />
Â  Â  Â  Â  <button class="btn" title="Use current location" id="useCurrentBtn">ğŸ“</button>
Â  Â  Â  Â  <input id="to" type="text" placeholder="To" aria-label="To location" autocomplete="off" aria-autocomplete="list" aria-controls="suggestions" />
Â  Â  Â  Â  <button class="btn" id="goBtn" title="Navigate">Go âœ</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="suggestions" role="listbox" aria-label="Location suggestions"></div>
Â  Â  <div class="travel-info-box" id="travelInfo" aria-live="polite">
Â  Â  Â  Â  <b>Trip Info</b><br />
Â  Â  Â  Â  Distance: -- km<br />
Â  Â  Â  Â  Estimated time: -- mins
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="mobile-button-container">
Â  Â  Â  Â  <button class="live-toggle" id="liveToggle" aria-pressed="false">Start Live Location</button>
Â  Â  Â  Â  <button class="cancel-trip" id="cancelTripBtn">Cancel Trip</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="offline-popup">
Â  Â  Â  Â  <div class="title">Downloading offline tilesâ€¦</div>
Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  <div id="offline-progress"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="offline-status">0%</div>
Â  Â  </div>
Â  Â Â 
Â  Â  <button id="downloadOfflinebtn">ğŸ“¥ Download for Offline</button>
Â  Â  <button id="darkModeBtn" title="Toggle Dark Mode">ğŸŒ™</button>

Â  Â  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
Â  Â  <script>
Â  Â  Â  Â  // --- CORRECTED JavaScript ---

Â  Â  Â  Â  // 1. Service Worker Registration (must be first)
Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('/sw.js').then(reg => {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ServiceWorker registered successfully. Scope:', reg.scope);
Â  Â  Â  Â  Â  Â  }).catch(err => console.error('ServiceWorker registration failed:', err));

Â  Â  Â  Â  Â  Â  // Listen for messages from the Service Worker for prefetch progress
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.addEventListener("message", (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = event.data || {};
Â  Â  Â  Â  Â  Â  Â  Â  const popupEl = document.getElementById("offline-popup");
Â  Â  Â  Â  Â  Â  Â  Â  const progressEl = document.getElementById("offline-progress");
Â  Â  Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById("offline-status");

Â  Â  Â  Â  Â  Â  Â  Â  if (data.type === 'PREFETCH_PROGRESS') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popupEl.style.display = "block";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pct = Math.round((data.done / data.total) * 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressEl.style.width = pct + "%";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = pct + "%";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (data.type === 'PREFETCH_DONE') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = "âœ… Done!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popupEl.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Map Initialization
Â  Â  Â  Â  const map = L.map('map').setView([26.8436, 75.565], 16);
Â  Â  Â  Â  const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  Â  Â  Â  Â  Â  maxZoom: 19,
Â  Â  Â  Â  Â  Â  attribution: '&copy; OpenStreetMap contributors'
Â  Â  Â  Â  }).addTo(map);

Â  Â  Â  Â  // 3. Application Data & Functions
Â  Â  Â  Â  const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjdlOTc2YTRjZTg1NDFjOTg5OTA3NjRkZjkzNjJlZjY5MGZmN2M2YTkxMWQ1ZjM3YzhmZWY4MjcxIiwiaCI6Im11cm11cjY0In0=';
Â  Â  Â  Â  const LANDMARKS = {
Â  Â  Â  Â  Â  Â  "AB1 Block": [26.842586, 75.564249],
Â  Â  Â  Â  Â  Â  "AB2 Block": [26.843117, 75.5661],
Â  Â  Â  Â  Â  Â  "AB3 Block": [26.84407, 75.564072],
Â  Â  Â  Â  Â  Â  "BlueDove Mess": [26.840432, 75.561798],
Â  Â  Â  Â  Â  Â  "BluSpring(INDYA) Mess": [26.841255, 75.561567],
Â  Â  Â  Â  Â  Â  "Laundry": [26.840202, 75.561454],
Â  Â  Â  Â  Â  Â  "Old Mess": [26.843112, 75.565209],
Â  Â  Â  Â  Â  Â  "Central Library": [26.841648, 75.565944],
Â  Â  Â  Â  Â  Â  "Lecture Hall Complex/ AB4 Block": [26.844338, 75.564705],
Â  Â  Â  Â  Â  Â  "Main Gate": [26.840729, 75.566325],
Â  Â  Â  Â  Â  Â  "Gate 2": [26.841524, 75.563868],
Â  Â  Â  Â  Â  Â  "Grand Stairs": [26.842507, 75.565467],
Â  Â  Â  Â  Â  Â  "Block G1": [26.840815, 75.563450],
Â  Â  Â  Â  Â  Â  "Block G2": [26.840642, 75.562629],
Â  Â  Â  Â  Â  Â  "Block G3": [26.840518, 75.562956],
Â  Â  Â  Â  Â  Â  "Block G4": [26.840587, 75.562146],
Â  Â  Â  Â  Â  Â  "G4 Badminton Court": [26.840350, 75.562369],
Â  Â  Â  Â  Â  Â  "Gym": [26.841210, 75.561594],
Â  Â  Â  Â  Â  Â  "Block B1": [26.841782, 75.562967],
Â  Â  Â  Â  Â  Â  "Block B3": [26.841413, 75.562431],
Â  Â  Â  Â  Â  Â  "Block B5": [26.841729, 75.561921],
Â  Â  Â  Â  Â  Â  "Block B2": [26.842045, 75.562189],
Â  Â  Â  Â  Â  Â  "Block B6": [26.842165, 75.561690],
Â  Â  Â  Â  Â  Â  "Block B7": [26.841859, 75.560896],
Â  Â  Â  Â  Â  Â  "Transformer": [26.841538, 75.560730],
Â  Â  Â  Â  Â  Â  "Chiller Panel Room": [26.841275, 75.560800],
Â  Â  Â  Â  Â  Â  "GHS Library": [26.840317, 75.561444],
Â  Â  Â  Â  Â  Â  "Jogger's Park": [26.840092, 75.563310],
Â  Â  Â  Â  Â  Â  "Subway Entrance": [26.842031, 75.563313],
Â  Â  Â  Â  Â  Â  "Saras Juice Corner": [26.840758, 75.563485],
Â  Â  Â  Â  Â  Â  "Subway Wraps": [26.841445, 75.563090],
Â  Â  Â  Â  Â  Â  "Taste Of India": [26.841445, 75.563090],
Â  Â  Â  Â  Â  Â  "Chatkara": [26.841445, 75.563090],
Â  Â  Â  Â  Â  Â  "Waffle Shop": [26.841399, 75.562809],
Â  Â  Â  Â  Â  Â  "Cook House": [26.840952, 75.563493],
Â  Â  Â  Â  Â  Â  "Administrative Block": [26.841672, 75.565992],
Â  Â  Â  Â  Â  Â  "AWS Building": [26.843797, 75.566947],
Â  Â  Â  Â  };
Â  Â  Â  Â  const HOSTEL_POLYGON = [
Â  Â  Â  Â  Â  Â  [26.84337, 75.56231], [26.83925, 75.56459], [26.83862, 75.56178], [26.84262, 75.56036]
Â  Â  Â  Â  ];
Â  Â  Â  Â  const COLLEGE_POLYGON = [
Â  Â  Â  Â  Â  Â  [26.84622, 75.56238], [26.83902, 75.56532], [26.84450, 75.56806], [26.84647, 75.56523]
Â  Â  Â  Â  ];
Â  Â  Â  Â  let routeLayer = null;
Â  Â  Â  Â  let fromMarker = null;
Â  Â  Â  Â  let toMarker = null;
Â  Â  Â  Â  let subwayMarker = null;
Â  Â  Â  Â  let watchId = null;
Â  Â  Â  Â  let liveMarker = null;
Â  Â  Â  Â  let liveAccuracyCircle = null;

Â  Â  Â  Â  function turfPoint(coords){ return { type: 'Feature', geometry: { type: 'Point', coordinates: coords } }; }
Â  Â  Â  Â  function turfPolygon(coords){ return { type: 'Feature', geometry: { type: 'Polygon', coordinates: coords } }; }
Â  Â  Â  Â  function turfBooleanPointInPolygon(pt, poly) {
Â  Â  Â  Â  Â  Â  const x = pt.geometry.coordinates[0], y = pt.geometry.coordinates[1];
Â  Â  Â  Â  Â  Â  const vs = poly.geometry.coordinates[0];
Â  Â  Â  Â  Â  Â  let inside = false;
Â  Â  Â  Â  Â  Â  for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const xi = vs[i][0], yi = vs[i][1];
Â  Â  Â  Â  Â  Â  Â  Â  const xj = vs[j][0], yj = vs[j][1];
Â  Â  Â  Â  Â  Â  Â  Â  const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi + 0.0) + xi);
Â  Â  Â  Â  Â  Â  Â  Â  if (intersect) inside = !inside;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return inside;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Corrected dark mode tile layer (CartoDB Voyager)
Â  Â  Â  Â  const darkLayer = L.tileLayer(
Â  Â  Â  Â  Â  Â  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
Â  Â  Â  Â  Â  Â  { attribution: '&copy; OpenStreetMap &copy; CartoDB' }
Â  Â  Â  Â  );

Â  Â  Â  Â  let isDark = false;

Â  Â  Â  Â  function toggleDark() {
Â  Â  Â  Â  Â  Â  if (!isDark) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(lightLayer);
Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(darkLayer);
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('dark-mode');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(darkLayer);
Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(lightLayer);
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('dark-mode');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  isDark = !isDark;
Â  Â  Â  Â  Â  Â  document.getElementById('darkModeBtn').innerHTML = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
Â  Â  Â  Â  }

Â  Â  Â  Â  function campusOf([lat, lon]) {
Â  Â  Â  Â  Â  Â  if (!lat || !lon) return null;
Â  Â  Â  Â  Â  Â  const point = turfPoint([lon, lat]);
Â  Â  Â  Â  Â  Â  if (turfBooleanPointInPolygon(point, turfPolygon([HOSTEL_POLYGON.map(c => [c[1], c[0]])]))) return 'hostel';
Â  Â  Â  Â  Â  Â  if (turfBooleanPointInPolygon(point, turfPolygon([COLLEGE_POLYGON.map(c => [c[1], c[0]])]))) return 'college';
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseCoords(loc) {
Â  Â  Â  Â  Â  Â  loc = loc.trim();
Â  Â  Â  Â  Â  Â  if (LANDMARKS[loc]) return LANDMARKS[loc];
Â  Â  Â  Â  Â  Â  const match = loc.match(/^\s*([+-]?\d+(\.\d+)?)\s*,\s*([+-]?\d+(\.\d+)?)\s*$/);
Â  Â  Â  Â  Â  Â  if (match) return [parseFloat(match[1]), parseFloat(match[3])];
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function cancelTrip() {
Â  Â  Â  Â  Â  Â  if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
Â  Â  Â  Â  Â  Â  if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; }
Â  Â  Â  Â  Â  Â  if (toMarker) { map.removeLayer(toMarker); toMarker = null; }
Â  Â  Â  Â  Â  Â  if (subwayMarker) { map.removeLayer(subwayMarker); subwayMarker = null; }
Â  Â  Â  Â  Â  Â  document.getElementById('travelInfo').innerHTML = `<b>Trip Info</b><br>Distance: -- km<br>Estimated time: -- mins`;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchRoute(start, end, useSubway = false) {
Â  Â  Â  Â  Â  Â  const url = 'https://api.openrouteservice.org/v2/directions/foot-walking/geojson';
Â  Â  Â  Â  Â  Â  const subwayCoords = LANDMARKS['Subway Entrance'];
Â  Â  Â  Â  Â  Â  const coords = [];
Â  Â  Â  Â  Â  Â  coords.push([start[1], start[0]]);
Â  Â  Â  Â  Â  Â  if (useSubway) coords.push([subwayCoords[1], subwayCoords[0]]);
Â  Â  Â  Â  Â  Â  coords.push([end[1], end[0]]);
Â  Â  Â  Â  Â  Â  const body = { coordinates: coords };
Â  Â  Â  Â  Â  Â  const res = await fetch(url, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': ORS_API_KEY, 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(body),
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (!res.ok) throw new Error('Routing request failed: ' + res.statusText);
Â  Â  Â  Â  Â  Â  return res.json();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function navigate() {
Â  Â  Â  Â  Â  Â  cancelTrip();
Â  Â  Â  Â  Â  Â  const fromInput = document.getElementById('from').value;
Â  Â  Â  Â  Â  Â  const toInput = document.getElementById('to').value;
Â  Â  Â  Â  Â  Â  if (!fromInput || !toInput) { alert('Please enter both From and To locations.'); return; }
Â  Â  Â  Â  Â  Â  const fromCoords = parseCoords(fromInput);
Â  Â  Â  Â  Â  Â  const toCoords = parseCoords(toInput);
Â  Â  Â  Â  Â  Â  if (!fromCoords || !toCoords) { alert('Please enter valid locations or coordinates.'); return; }
Â  Â  Â  Â  Â  Â  const fromCampus = campusOf(fromCoords);
Â  Â  Â  Â  Â  Â  const toCampus = campusOf(toCoords);
Â  Â  Â  Â  Â  Â  const mustUseSubway = fromCampus && toCampus && fromCampus !== toCampus;
Â  Â  Â  Â  Â  Â  const useSubway = mustUseSubway;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const routeGeojson = await fetchRoute(fromCoords, toCoords, useSubway);
Â  Â  Â  Â  Â  Â  Â  Â  routeLayer = L.geoJSON(routeGeojson, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style: { color: '#ff7e5f', weight: 6, opacity: 0.85 },
Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  const bounds = routeLayer.getBounds();
Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds(bounds.pad(0.15));
Â  Â  Â  Â  Â  Â  Â  Â  const summary = routeGeojson.features[0].properties.summary;
Â  Â  Â  Â  Â  Â  Â  Â  const distKm = summary.distance / 1000;
Â  Â  Â  Â  Â  Â  Â  Â  const durationMins = Math.round(summary.duration / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const travelInfoEl = document.getElementById('travelInfo');
Â  Â  Â  Â  Â  Â  Â  Â  travelInfoEl.innerHTML = `<b>Trip Info</b><br>Distance: ${distKm.toFixed(2)} km<br>Estimated time: ${durationMins} mins`;
Â  Â  Â  Â  Â  Â  Â  Â  fromMarker = L.marker(fromCoords, { title: 'Start (From)', icon: L.divIcon({ className: 'start-marker', html: '<div style="background:#ff7e5f; border-radius:50%; width:24px; height:24px; color:#fff; font-weight:700; display:flex; justify-content:center; align-items:center;">A</div>', iconSize: [24,24], iconAnchor: [12,12] }) }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  toMarker = L.marker(toCoords, { title: 'End (To)', icon: L.divIcon({ className: 'end-marker', html: '<div style="background:#ff7e5f; border-radius:50%; width:24px; height:24px; color:#fff; font-weight:700; display:flex; justify-content:center; align-items:center;">B</div>', iconSize: [24,24], iconAnchor: [12,12] }) }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  if (useSubway) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sc = LANDMARKS['Subway Entrance'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subwayMarker = L.circleMarker(sc, { radius: 8, color: '#2d3436', fillColor: '#fff', weight: 2 }).bindPopup('Subway (required transfer)').addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  travelInfoEl.innerHTML += `<br><small style="font-weight:600;">Note: Transfer via Subway is required between campuses.</small>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Could not calculate route: ' + e.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showSuggestions(input) {
Â  Â  Â  Â  Â  Â  const val = input.value.trim().toLowerCase();
Â  Â  Â  Â  Â  Â  const suggestBox = document.getElementById('suggestions');
Â  Â  Â  Â  Â  Â  suggestBox.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (!val) {
Â  Â  Â  Â  Â  Â  Â  Â  suggestBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const matches = Object.keys(LANDMARKS).filter((name) => name.toLowerCase().includes(val));
Â  Â  Â  Â  Â  Â  if (matches.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  suggestBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  suggestBox.style.display = 'block';
Â  Â  Â  Â  Â  Â  matches.forEach((name) => {
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.textContent = name;
Â  Â  Â  Â  Â  Â  Â  Â  div.setAttribute('role', 'option');
Â  Â  Â  Â  Â  Â  Â  Â  div.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  suggestBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  suggestBox.appendChild(div);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  ['from', 'to'].forEach((id) => {
Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  el.addEventListener('input', () => showSuggestions(el));
Â  Â  Â  Â  Â  Â  el.addEventListener('focus', () => showSuggestions(el));
Â  Â  Â  Â  Â  Â  el.addEventListener('keydown', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigate();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  function useCurrentLocationAsFrom() {
Â  Â  Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Geolocation not supported by your browser.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition((pos) => {
Â  Â  Â  Â  Â  Â  Â  Â  const lat = pos.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  const lon = pos.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('from').value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
Â  Â  Â  Â  Â  Â  Â  Â  map.setView([lat, lon], 17);
Â  Â  Â  Â  Â  Â  }, () => alert('Unable to get your current location.'));
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleLive() {
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('liveToggle');
Â  Â  Â  Â  Â  Â  if (watchId) {
Â  Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.clearWatch(watchId);
Â  Â  Â  Â  Â  Â  Â  Â  watchId = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (liveMarker) map.removeLayer(liveMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (liveAccuracyCircle) map.removeLayer(liveAccuracyCircle);
Â  Â  Â  Â  Â  Â  Â  Â  liveMarker = null;
Â  Â  Â  Â  Â  Â  Â  Â  liveAccuracyCircle = null;
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Start Live Location';
Â  Â  Â  Â  Â  Â  Â  Â  btn.setAttribute('aria-pressed', 'false');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Geolocation not supported by your browser.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = '...Tracking';
Â  Â  Â  Â  Â  Â  Â  Â  btn.setAttribute('aria-pressed', 'true');
Â  Â  Â  Â  Â  Â  Â  Â  watchId = navigator.geolocation.watchPosition(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (pos) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lat = pos.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lon = pos.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const acc = pos.coords.accuracy || 20;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!liveMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liveMarker = L.circleMarker([lat, lon], {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: 10,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fillColor: '#ff7e5f',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#fff',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weight: 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fillOpacity: 0.9
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(map).bindPopup("You (Live)").openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liveMarker.setLatLng([lat, lon]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!liveAccuracyCircle) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liveAccuracyCircle = L.circle([lat, lon], {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: acc,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: "#ff7e5f",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fillOpacity: 0.1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weight: 1
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liveAccuracyCircle.setLatLng([lat, lon]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liveAccuracyCircle.setRadius(acc);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.setView([lat, lon], 17);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Stop Live Location';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Geolocation error:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error getting location. Tracking stopped.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleLive();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function prefetchTiles() {
Â  Â  Â  Â  Â  Â  const bbox = [75.5595, 26.8385, 75.5715, 26.8485];
Â  Â  Â  Â  Â  Â  const zooms = [15, 16, 17, 18];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Service Worker is not active yet. Please refresh the page and try again.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById("offline-popup").style.display = "block";
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({ type: 'PREFETCH_TILES', bbox: bbox, zooms: zooms });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Attach event listeners to buttons
Â  Â  Â  Â  document.getElementById('goBtn').addEventListener('click', navigate);
Â  Â  Â  Â  document.getElementById('useCurrentBtn').addEventListener('click', useCurrentLocationAsFrom);
Â  Â  Â  Â  document.getElementById('liveToggle').addEventListener('click', toggleLive);
Â  Â  Â  Â  document.getElementById('cancelTripBtn').addEventListener('click', cancelTrip);
Â  Â  Â  Â  document.getElementById('downloadOfflinebtn').addEventListener('click', prefetchTiles);
Â  Â  Â  Â  document.getElementById('darkModeBtn').addEventListener('click', toggleDark);
Â  Â  </script>
</body>
</html>
